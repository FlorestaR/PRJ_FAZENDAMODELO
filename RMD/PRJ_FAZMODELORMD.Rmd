---
title: "Descrição das etapas de processamento de dados de inventário realizado com o auxílio da tecnologia LiDAR"
author: "Otávio Magalhães Silva Souza"
output: 
  pdf_document:
#    toc: true
#    toc_depth: 3
    fig_caption: true
    number_sections: true
    citation_package: natbib
    keep_tex: true
    latex_engine: pdflatex
---

```{r setup, include=FALSE}
library(tidyverse)
library(sf)
library(tidyterra)
library(terra)
library(stars)
library(tools)
library(RColorBrewer)
library(progress)
library(reshape2)
library(mapview)
library(lidR)
library(RCSF)
library(future)
library(forestinventory)
```

```{r, echo=FALSE, fig.align='center', out.width="40%"}
knitr::include_graphics("IMAGES/CAPA.png")
```

\centerline {Piracicaba, SP – Data de Emissão: `r format(Sys.Date(), '%d de %B de %Y')`}
\newpage


\tableofcontents


\newpage
# Pacotes utilizados no R (colocar breve descrição - já tem uma descriçãozinha no R passado em aula)
## Tidyverse (https://livro.curso-r.com/4-2-tidyverse.html)

O Tidyverse é um pacote guarda-chuva e contém diversas funções úteis para garantir o dinamismo no script, visualização, processamento e análise dos dados, modelagem etc. 

```{r, echo=FALSE, fig.cap='Tidyverse', fig.align='center', out.width="60%"}
knitr::include_graphics("IMAGES/tidyverse.png")
```

## Sf

Pacote utilizado para manipulação de objetos do mundo real. Descreve a forma com que esses objetos podem ser armazenados e importados e quais operações geométricas podem ser definidas por eles. 

## Tidyterra
## Terra
## Stars
## Tools
## RColorBrewer
## Progress
## Reshape2
## Mapview
## LidR
## RCSF
## Future

\newpage
<!-- localização da área, nuvem LiDAR e mapa -->
# Descrição da área 
A área a ser estudada como "Fazenda Modelo" localiza-se no município de São Miguel Arcanjo (SP), pode ser identificada pelas coordenadas (-23.86707°,  -47.87772°) e possui 129,784 ha, que dividem-se em 4 subtalhões: 301a (18,933 ha), 301d (34,468 ha), 302a (47,602 ha) e 302c (28,781 ha).

```{r, echo=FALSE, fig.cap='Mapa da propriedade', fig.align='center', out.width="60%"}
knitr::include_graphics("IMAGES/mapafazendamodelo.png")
```
```{r, echo=FALSE, fig.cap='Nuvens LiDAR normalizadas', fig.align='center', out.width="40%", fig.show='hold'}
knitr::include_graphics(c("IMAGES/nuvensnormalizadas.png","IMAGES/nuvensnormalizadaszoom.png"))
```
<!-- Imagem das feições selecionadas, colocar dados no QGiS -->
\newpage
# Grid e parcelas já inventariadas 
A região foi dividida em 3454 parcelas, onde 2960 delas possuem 400m², enquanto as outras são menores por estarem na borda e abrangerem áreas além da área de interesse. Além disso, 13 das parcelas possuem dados de inventário florestal e podem ser identificadas pelos seguintes Id's: 993, 1526, 1770, 1881, 3165, 3628, 3660, 3730, 5052, 5091, 5106 e 5122.
```{r, echo=FALSE, fig.cap='Parcelas com dados de inventário', fig.align='center', out.width="40%"}
knitr::include_graphics("IMAGES/parcelasinventariadas.png")
```

\newpage

# Processamento da nuvem LiDAR

``` {r, echo=FALSE, fig.cap='Fluxograma do processamento da nuvem LiDAR', fig.align='center', out.width = "80%"}
knitr::include_graphics("IMAGES/fluxograma-funcoes.png")
```

- 1. Conferir especificações: Verificar se a nuvem gerada se enquadra no que é esperado: densidade de pontos, área escaneada, classificação de pontos etc;  

- 2. Arrumar nuvens: Verificação do sistema de coordenadas utilizado e atributos de latitude, longitude e elevação;  
  
- 3. Quadricular: Repartição da nuvem em pedaços menores a fim de ganhar eficiência no processamento em paralelo;  

- 4. Definir solo e determinar altura dos pontos: Assegura e certifica a classificação do solo por diferentes métodos;  
  
- 5. Classificar outros pontos e ruídos: Separar os pontos restantes por sua natureza (edificações, corpos d'água etc);  

- 6. Quadrículas limpas: Remoção dos ruídos após classificação;  

- 7. Produção de mapas DTM (elevação do solo), DSM (elevação do solo + vegetação) e DEM (elevação da vegetação);  

- 8. Normalização da nuvem: Joga tudo pro mesmo plano;  

- 9. Cálculo de métricas LiDAR: O p90 (percentil 90) representa a altura em que 90% dos pontos da nuvem LiDAR se encontram abaixo desta. Cada quadrícula possui o seu própio p90 e ele tende a apresentar boa correlação com a realidade de campo. A intenção de exisitrem diversas métricas LiDAR é a de ver quais delas possuem boa correlação com os atributos de interesse.

``` {r, echo=FALSE, fig.cap='Esquematização do processo de inventário com ALS e informação terrestre', fig.align='center', out.width = "40%"}
knitr::include_graphics("IMAGES/als-e-info-campo.png")
```

\newpage

## Fluxograma e plots relacionados à Dupla Amostragem proposta em Inventário Florestal   

``` {r, echo=FALSE, fig.cap='Fluxograma das etapas de processamento de dados LiDAR para fins de inventário florestal', fig.align='center', out.width = "80%"}
knitr::include_graphics("IMAGES/fluxogramaDA.png")
```

1. Carregamento dos pacotes
  i. Diversos são os pacotes carregados. Os nomes e a utilidade de cada um estão descritos na primeira seção do documento.
\newpage
2. Definição das pastas e local de trabalho  

* GitHub
  i. C: - pasta raiz
  ii. GitRepo - diretório em que estão agrupados os arquivos a serem upados no GitHub
  iii. PRJ_FAZENDAMODELO - pasta do projeto
  iv. RMD - código e arquivos utilizados na redação do presente documento
  v. RESULTADOS - plot da matriz de correlação
  vi. BATCHR - arquivo tipo R com os scripts utilizados no pré e pós-processamento dos dados
  vii. SAIDASSIG - arquivos gerados no QGIS
  viii. SHAPES - arquivos de entrada para uso no SIG  
  
* LiDAR 
  i. C: - pasta raiz
  ii. LiDAR - agrupa todos as nuvens de pontos utilizadas no script
  iii. PRJ_FAZENDAMODELO - pasta do projeto
  iv. NUVENS - onde se localizam as nuvens de pontos
  v. A13 - reúne as nuvens do ano de 2013
  vi. TALHOES - nuvem segregada por talhão
  vii. NoNORM - nuvens com solo classificado
  viii. SiNORM - nuvens com solo classificado e normalizadas
  ix. RSTR_qua - raster apresentando a estimativa da variável de interesse para cada talhão
  
``` {r, echo=FALSE, fig.cap='Organização dos diretórios', fig.align='center', out.width = "80%"}
knitr::include_graphics("IMAGES/organizacao-pastas.png")
```

\newpage  

3. Definição das funções para criação dos gráficos  

\newpage  

4. Definição das equações (estudar quais são)  

\newpage  

5. Download e leitura dos dados LiDAR
  i. Ao todo foram baixadas 6 nuvens de pontos LiDAR, que antes do processamento encontravam-se da seguinte maneira:  
  
``` {r, echo=FALSE, fig.cap='Nuvens de pontos LiDAR pré-processadas', fig.align='center', out.width = "40%"}
knitr::include_graphics("IMAGES/pre-clipagem-passo8.png")
```

  ii. As nuvens foram baixadas pelo seguinte link: https://github.com/FlorestaR/dados/blob/main/5_LIDARF/Modelo/CLOUDS/

\newpage

6. Download e leitura dos dados em Shapefile  
  i. Os shapes foram baixados pelo seguinte link: https://github.com/FlorestaR/dados/blob/main/5_LIDARF/Modelo/SHAPES
  
``` {r, echo=FALSE, fig.cap='Dados contidos nas parcelas inventariadas', fig.align='center', out.width = "50%"}
knitr::include_graphics("IMAGES/atributosinventariadas.png")
```

\newpage

7. Clipagem da nuvem para eliminação de dados indesejados (mostrar nuvem antes e depois)  
Antes da clipagem: 68mi pontos  
Após clipagem: 18mi pontos

``` {r, echo=FALSE, fig.cap='Comparativo entre as nuvens de pontos antes e após a clipagem', fig.align='center', out.width = "40%", fig.show='hold'}
knitr::include_graphics(c("IMAGES/pre-clipagem-passo8.png","IMAGES/pos-clipagem-passo8.png"))
```

\newpage

8. Classificação

``` {r, echo=FALSE, fig.cap='Processamento e resultado da classificação de solo das nuvens LiDAR', fig.align='center', out.width = "40%", fig.show='hold'}
knitr::include_graphics(c("IMAGES/classificacao-pontos-de-solo.png","IMAGES/nuvem-com-pontos-de-solo-classificados-mas-sem-normalizacao.png"))
```

\newpage

9. Normalização
  i. A etapa de normalização tem por finalidade nivelar toda a nuvem e é um passo que está diretamente correlacionado à classificação do solo.

``` {r, echo=FALSE, fig.cap='Resultado da normalização das nuvens', fig.align='center', fig.show='hold', out.width = "40%"}
knitr::include_graphics(c("IMAGES/nuvensnormalizadas.png","IMAGES/nivelamento.png"))
```

\newpage

10. Recorte da nuvem em tiles 300x300m
  O recorte da nuvem em tiles menores tme a função de facilitar o processamento dos dados, tornando-o mais rápido e dinâmico

``` {r, echo=FALSE, fig.cap='Retile da nuvem em quadrados de 300x300m', fig.align='center', out.width = "50%"}
knitr::include_graphics("IMAGES/Retile.png")
```

\newpage

11. Cálculo de métricas para cada voxel (explicar voxel)

``` {r, echo=FALSE, fig.cap='Cálculo das métricas para cada voxel', fig.align='center', out.width = "50%"}
knitr::include_graphics("IMAGES/calculo-metricas-voxel.png")
```
\newpage

12. Seleção de um grupo de métricas para estudo de correlação

``` {r, echo=FALSE, fig.cap='Tabela com as métricas escolhidas', fig.align='center', out.width = "50%"}
knitr::include_graphics("IMAGES/tb-subgrupo-de-metricas-p-analise.png")
```

\newpage

13. Análise da correlação por meio de gráfico (falar do gráfico)

``` {r, echo=FALSE, fig.cap='Resultado da análise de correlação', fig.align='center', out.width = "50%"}
knitr::include_graphics("IMAGES/MatrizDeCorrelacoes.jpg")
```

\newpage

14. Determinação do modelo de predição

``` {r, echo=FALSE, fig.cap='nao sei', fig.align='center', out.width = "50%"}
knitr::include_graphics("IMAGES/analise-de-regressao.png")
```

\newpage

15. Criação de mapas raster e gráficos

\newpage

# Dupla Amostragem  

A dupla amostragem é composta por duas fases (s1 e s2) - LiDAR  

- s1: compreende uma gama de variáveis explanatórias para cada ponto pertencente a s1. As variáveis explanatórias derivam de informações auxiliares disponíveis em grande quantidade ao longo da área florestal;  
- s2: constitui o inventário terrestre feito num número limitado de subamostras, onde todas pertencem a s1 e fornecem o valor das variáveis de interesse, ex. densidade local.  

- É importante que s1 tenha uma grande intensidade amostral, de modo a que a média ou o total amostral da medida auxiliar possa ser estimado com precisão, sem erros amostrais. É uma variável barata e que pode ser encontrada em abundância na floresta. Os estimadores de razão e regressão utilizam a relação entre essa variável e a variável de interesse (cara e de difícil medição - VTCC) para garantir melhor precisão ao cálculo.

- O processo: busca-se estimar a média populacional da medida de interesse (ex. em média, quantos m³ de madeira há por hectare?) e obter um indicativo da confiabilidade do cálculo (variância). Para aumentar a precisão da estimativa da média (diminuir a variância), utiliza-se a variável auxiliar que é de fácil observação e está associada à variável de interesse (aqui entra estimador de razão/regressão). Este movimento de redução da variância da média da medida de interesse ocorre de formas diferentes nas DA de ***fase 2 de subamostra (onde todas as parcelas pertencem à fase 1) e fase 2 independente (há sorteio, então nem todas as parcelas inventariadas de forma intensiva fazem parte da fase 1)*** TA CERTO ISSO??? APARENTEMENTE OS DOIS TIPOS DE FASE 2 SE DIVIDEM EM: SORTEIO ALEATORIO DAS AMOSTRAS E ESTRATIFICACAO 

- Exemplo prático e definições (https://www.ipef.br/publicacoes/scientia/nr108/cap09.pdf);

- O erro amostral (E%) é calculado a partir do desvio padrão S², que representa a variação de uma série de médias retiradas da população;

- A alta correlação entre métricas LiDAR e parâmetros biofísicos da floresta justificam a adoção da tecnologia na primeira fase da DA, além de reduzir a intensidade amostra (custo e trabalho). A amostragem dupla ganha maior precisão pela adoção dos estimadores de razão e regressão e para isso a média ou o total populacional da variável auxiliar deve ser conhecido e sem erro amostral. ;  


``` {r, echo=FALSE, fig.cap='Modelo para cálculo da VTCC', fig.align='center', out.width = "60%"}
knitr::include_graphics("IMAGES/eq-estimador-regressao.png")
```

\newpage

# Fluxograma e etapas Tripla amostragem

Composta por 3 fases, s0, s1 e s2:  

- O princípio básico é o de que as variáveis explanatórias derivadas das informações auxiliares estão disponíveis em duas frequências diferentes. A fase s0 fornece informações sobre toda a área, enquanto s1 possui dados adicionais de amostras de s0. Logo, a partir da informação terrestre coletada de um número x de parcelas de campo (1 camada de informação) é possível aferir sobre informações adicionais para outras parcelas a partir do uso de preditores (2 camadas de informação) ***É ISSO MESMO? A CAMADA S1 É COMPOSTA POR DADOS ESTIMADOS?*** e, por fim, o LiDAR coleta dados sobre todas as parcelas (3 camadas de informação).  

- Logo, a motivação por trás da TA é a de que a gama de informações de s1 adiciona alto poder preditivo às variáveis disponíveis para todas as parcelas da área (s0)  

``` {r, echo=FALSE, fig.cap='Esquema TA com Lidar', fig.align='center', out.width = "50%"}
knitr::include_graphics("IMAGES/esquematizacao-TA.png")
```

**Estimativas de pequenas áreas (small area estimation)**  

- Para sub áreas da floresta onde há pouca informação terrestre, como em G na figura acima. Para essas áreas, o uso da amostragem multifásica pode ser mais eficiente, já que utilizam um número reduzido de parcelas em campo para chegar à mesma precisão da ACE e ACS. Por outro lado, a sub área em questão pode ser pequena demais para justificar a adoção de um modelo de regressão separado, uma vez que este pode resultar em um intervalo de confiança indesejadamente abrangente;  

- A ideia, então, é a de utilizar toda a riqueza de informações presente nas amostras de S2 para ajustar o modelo (equação utilizada para o cálculo de uma variável de interesse) e aplicá-lo para a sub área em questão.  

- O potencial viés que surge da aplicação do modelo na sub área é corrigido pelo uso de modelos residuais empíricos derivados da área amostrada em campo. (não entendi direito essa parte) - trecho no texto:  The potential bias of applying that model in G is then corrected for by using the empirical model residuals derived from that small area.  

- Caso não existam parcelas de campo na sub área, então deve-se aceitar o viés na estimativa e no modelo. São essas as estimativas sintéticas, mas apesar do viés é possível calcular a sua variação.  

**DESIGN-BASED VS MODEL-DEPENDENT APPROACH (ver dps)**  

- Model-dependent approach: as parcelas amostrais são fixas e as observações retiradas desses locais são assumidas como variáveis aleatórias, assim como a floresta assume o papel de ser o meio realizador desse processo estocástico (?????? o que isso significa?). Embora os locais das parcelas possam ser arbitrariamente escolhidos, o modelo deve escrever adequadamente o processo estocástico, a fim de garantir resultados parciais. (????)  

- Os estimadores do forestinventory se baseiam na design-based approach. Design-based approach baseia-se na randomização dos locais de amostra de forma uniforme e independente. Logo, a floresta por si só e qualquer valor de densidade local de x (pertencente a) F (floresta) são fixos e não um resultado de um processo estocástico (estudar). (???)  

- Na estrutura do Model-dependent approach as parcelas são fixas e resultam em um processo estocástico
GPT: what is the difference between design-based approach and model-dependent approach?  

# Regressão linear simples  
Modelar a relação entre duas variáveis e se expressa na forma de uma reta no plano cartesiano.

``` {r, echo=FALSE, fig.cap='Equação base da regressão linear simples', fig.align='center', out.width = "80%"}
knitr::include_graphics("IMAGES/eq-base-regressao-linear.png")
```
- *Y = variável resposta ou variável dependente*  
- *X = variável independente, regressora ou explicativa*  
- *Épsilon = erro. Pode ser que a Y seja explicada por X, mas falte algo que explique essa variabilidade. É a flutuação aleatória que ocorre ao tentar explicar Y por X. Seja por imperfeição do modelo, erros na mensuração ou outras variáveis fora de controle.*

\newpage

# Arborimetria preditiva

- Em florestas plantadas há grande relação entre o DAP e a altura da árvore. O procedimento de medição de campo é o seguinte: 1 - DAP de todas as árvores da parcela; 2 - altura total de uma amostra da parcela; 3 - estima-se a relação entre o DAP e a altura total da amostra; 4 - utiliza essa relação para predizer a altura de todas as árvores da parcela.  

- A seleção das árvores da amostra pode ser feita de forma aleatória ou sistemática. A seleção aleatória garante maior confiabilidade, enquanto a sistemática é mais simplificada (ex. 1 árvore a cada 15).  

- A ***relação hipsométrica** é a relação média entre o DAP e a altura das árvores individuais. A curva sigmóide é o melhor modelo para a relação média entre o DAP e a altura.  

``` {r, echo=FALSE, fig.cap='Quadro de modelos não lineares (esquerda) e lineares (direita)', fig.align='center', out.width = "45%"}
knitr::include_graphics(c("IMAGES/modelo-nao-linear.jpeg","IMAGES/modelo-linear.jpeg"))
```

- Um modelo é linear quando cada termo é uma constante ou o produto de um parâmetro e uma variável preditora. Uma equação linear é construída adicionando os resultados para cada termo. Modelos lineares seguem esse padrão: Resposta = constante + parâmetro * preditor + ... + parâmetro * preditor. Caso contrário a equação é não-linear.  

- O postulado de Cotta define que o volume de uma árvore depende do seu diâmetro, altura e forma. Todas as árvores de mesmo diâmetro, altura e forma possuem o mesmo volume. Isso serve para o lenho de tronco único. O fator forma pode ser visto como um índice quantitativo que representa a razão entre o volume sólido e cilíndrico de uma árvore. O volume sólido de uma amostra da parcela pode ser medido por cubagem rigorosa. O fator forma é igual ao somatório dos volumes sólidos dividido pelo somatório dos volumes cilíndricos ([pi/4] * d² * h).  

- O volume de uma dada árvore é o resultado da multiplicação entre o fator de forma e o volume cilíndrico do indivíduo. A seleção das árvores deve ser aleatória, sem preocupação em selecionar árvores de todas as classes de DAP e altura. ***Vamos usar o LiDAR TLS para estimar o diâmetro e a forma?***  

- O volume pode ser calculado em função de diferentes variáveis preditoras, como a altura, DAP, altura até a primeira ramificação ou outro. Equações de dupla entrada ou equações padrão são aquelas que utilizam o DAP e a altura para cálculo do volume.  

- A  relação entre o volume sólido e o volume cilíndrico tende à uma relação de proporcionalidade (a curva que os representa passa pela origem). Com a adoção do volume comercial, são consideradas as árvores a partir de um tal diâmetro, o que afasta a curva da origem e, portanto, não evidencia uma relação proporcional.  

- É possível modelar o fator de forma como uma função do DAP ao invés de encontrá-lo a partir da relação entre o DAP e a altura. É adequado para quando a forma da árvore muda de acordo com o DAP.  

``` {r, echo=FALSE, fig.cap='Equação base da regressão linear simples', fig.align='center', out.width = "80%"}
knitr::include_graphics("IMAGES/dupla-entrada-volume.jpeg")
```

\newpage

# Silvimetria com medidas auxiliares

- Medidas de fácil obtenção: densidade de estande e área basal e possuem boa relação com as estimativas de produção (volume). Existem dois tipos de relação entre as medidas auxiliares e as de interesse e resultam em dois estimadores diferentes: estimadores de razão (razão entre a medida de interesse e a auxiliar) e o estimador de regressão (relação entre as duas medidas é uma relação linear simples).  

- Estimador de razão é a razão entre a medida de interesse e a medida auxiliar. A razão pode ser em relação ao total ou às médias das medidas. Ex: saber o total das árvores em vias públicas de uma cidade (caso 1); saber a proporção das vias públicas sombreadas por árvores (caso 2). O primeiro caso se trata de um total - número de árvores na cidade -, o segundo caso envolve a razão entre a área sombreada e área total das vias públicas. O estimador de razão é uma razão das médias, e não uma média das razões.  

$R = \frac{ (1/n)\sum^{n}_{i=1} Yi}{ (1/n)\sum^{n}_{i=1} Xi} = \frac{\sum^{n}_{i=1} Yi}{\sum^{n}_{i=1} Xi} = \frac{Total Y}{Total X}$

- *R* é o estimador de razão
- *i* indica os arvoredos da amostra *(i = 1, 2, ..., n)*
- *Yi* é a observação da medida de interesse no arvoredo *i*
- *Xi* é a observação da medida auxiliar no mesmo arvoredo *i*

- O estimador de razão nada mais é do que a soma das médias da medida de interesse divida pela soma soma das médias da medida auxiliar. é um meio para obter a estimativa da média da variável de interesse com maior precisão. Quanto maior a relação entre a medida de interesse e a medida auxiliar, menor é a soma de quadrados da expressão $\sum(Yi - R * Xi)^2$ ***FORMULA VARIANCIA ESTIMADOR DE RAZAO E FORMULA DA VARIANCIA POPULACIONAL - PG 296***

- O estimador de razão requer o conhecimento da *média* ou do *total populacional* da variável auxiliar, que é um atributo dos arvoredos, a exemplo da densidade de estande e da área basal, o que poderia ser obtido a partir de um censo, descartando erros, mas é caro. O estimador de razão é utilizado nas situações em que a medida de interesse (Y) é diretamente proporcional à medida auxiliar (X). Logo, deve satisfazer 3 condições:  
1. A relação média entre Y e X é linear: pode ser representada por uma reta;
2. A reta X-Y passa pela origem do plano cartesiano;
3. O grau de dispersão dos valores de Y (denota a variância) ao redor da reta é proporcional aos valores de X.  

- O **Estimador de regressão** é utilizado na existência de uma relação linear entre a variável de interesse e a auxiliar, porém a reta que as representa não passa pela origem. Logo, o estimador de regressão possui uma abordagem mais generalista, pois é eficiente mesmo quando as medidas da variável auxiliar e de interesse estão negativamente associadas - inversamente proporcionais.  

# R utilizando database grisons

- Para essa etapa será utilzado o database "grisons". A fase s1 é composta por 306 amostras (phase_id_2p) escaneadas com LiDAR e s2 possui 67 subamostras de s1, de onde se calculou o volume com os dados terrestres.
- Para estimadores globais de dupla amostragem, devemos especificar:  
1. O modelo de regressão (formula);
2. O dataframe que possui as informações de inventário;
3. O objeto de lista (*list*) *phase-id* contendo: o argumento *phase.col* identificando o nome da coluna e especificando para s1 ou s2.
4. Argumento terrgrid.id, que especifica qual valor numérico indica s2 na coluna.
5. Opcional: coluna contendo os tamanhos de borda

``` {r, warning=FALSE}
head(grisons)
```

- Cria-se um modelo para o cálculo do volume a partir da regressão múltipla da média das alturas (mean), desvio padrão dessa média (stddev), altura máxima (max) e p75 (q75). O modelo retorna a estimativa, a variância externa (variância causada por fatores externos e que não são contemplados pelo modelo - ex. ansiedade do participante ao realizar um teste cognitivo), a variância peso-g (contempla a força de um fator geral para a avaliação sobre os itens medidos. É como se houvessem pesos diferentes para os critérios - lembra uma média ponderada), a quantidade de amostras utilizadas em s1 e s2 e o R² (correlação entre as variáveis). A variância peso-g geralmente é mais preferível. 

``` {r, warning=FALSE}
reg2p_nex <- twophase(formula = tvol ~ mean + stddev + max + q75, 
                      data = grisons, phase_id = list(phase.col = "phase_id_2p",
                      terrgrid.id = 2), boundary_weights = "boundary_weights")
summary(reg2p_nex)
```

- O estimador exaustivo pode ser aplicado passando adicionalmente um vetor que contenha as exatas médias das variáveis explanatórias através do argumento *exhaustive*. Este vetor deve ser calculado previamente de tal maneira que qualquer ajuste de borda desejado já tenha sido aplicado. Enquanto um estimador exaustivo utiliza toda a informação disponível no conjunto de dados para gerar a informação, o estimador não-exaustivo, por sua vez, não utiliza toda a informação.

``` {r, warning=FALSE}
colnames(lm(formula = tvol ~ mean + stddev + max + q75, data = grisons, x = TRUE)$x)
```

***Não entendi o código acima***

- O estimador exaustivo pode ser aplicado após definir o vetor com as exatas médias, *true.means.Z*:

``` {r, warning=FALSE}
true.means.Z <- c(1, 11.39, 8.84, 32.68, 18.03)
reg2p_ex <- twophase(formula = tvol ~ mean + stddev + max + q75,
                     data = grisons, phase_id = list (phase.col = "phase_id_2p",
                      terrgrid.id = 2), exhaustive = true.means.Z)

summary(reg2p_ex)
```

- As variâncias que resultam do cálculo através dos estimador exaustivo são menores do que o valor encontrado pelos estimadores não-exaustivos, uma vez que foram trocadas as médias estimadas das variáveis explanatórias pelas médias reais.

# Resultado

Two-Phase global estimation
 
Call: 
twophase(formula = VTCC ~ zq95, data = X, phase_id = list(phase.col = "Inventario", 
    terrgrid.id = 2), boundary_weights = "boundaryweights")

Method used:
Non-exhaustive global estimator
 
Regression Model:
VTCC ~ zq95

Estimation results:
 estimate ext_variance g_variance   n1 n2 r.squared
 185.5156     58.22226    259.216 3453  8 0.7322413

'boundary_weight'- option was used to calculate weighted means of auxiliary variables

